Obs.: usar o "GUIA_DESENVOLVEDOR.md" para a IA entender melhor como fazer alterações no projeto.

**REFATORAÇÃO (18/12/2025):**
- [18/12/2025] Criados arquivos `constants.py` e `flow_helpers.py` para eliminar hardcoding e código duplicado
- [18/12/2025] **Etapa 1/6**: Refatorado estado MENU_PRINCIPAL em `whatsapp_flow.py`: substituídos números mágicos ('1', '2', '3', '4') por constantes nomeadas (BUTTON_ID_AGENDAR, etc.), substituída lógica is_back/is_cancel por UniversalActions, e substituídas strings de sessão por SessionKeys. Código mais legível e manutenível.
- [18/12/2025] **Etapa 2/6**: Refatorados estados REAGENDAR e CANCELAR em `whatsapp_flow.py`: **eliminadas ~80 linhas de código duplicado!** Ambos estados agora usam helpers `get_future_appointments()` e `format_appointment_list()`, reduzindo de 71 linhas para 31 linhas cada (-56% de código). Zero duplicação.
- [18/12/2025] Renomeado botão do menu principal: "Cancelar" → "Cancelar Agendamento" (`messages.py:18`) para evitar confusão com a ação "Cancelar operação" (botão que aborta o fluxo atual).
- [18/12/2025] **Etapa 3/6 e 4/6**: Refatorados estados AGENDAR, ESCOLHER_DIA, ESCOLHER_HORARIO, CONFIRMAR e CONFIRM_CANCEL_APPOINTMENT em `whatsapp_flow.py`: todos agora usam constantes (BUTTON_ID_*), SessionKeys centralizados, helpers de limpeza (cleanup_agendamento_session), e helpers de formatação (format_data_pt).
- [18/12/2025] **Mensagens de confirmação melhoradas**: Adicionadas mensagens visuais com emojis em `messages.py` (AGENDAMENTO_CONFIRMADO_FULL, REAGENDAMENTO_CONFIRMADO, CANCEL_SUCCESS_TEMPLATE) que mostram data, horário e informações relevantes de forma clara e amigável ao usuário.
- [18/12/2025] Corrigido bug onde mensagens de confirmação não eram exibidas: o webhook (`whatsapp_webhook.py:625-647`) agora detecta quando a resposta contém TANTO uma mensagem de confirmação QUANTO o menu, e envia primeiro a confirmação como texto, depois os botões do menu separadamente. Antes, apenas o menu era enviado e a confirmação era perdida.
- [18/12/2025] **Sistema de janela deslizante de slots implementado**: Adicionada função `adicionar_slots_dia_futuro()` em `agenda_service.py` (linhas 555-634) que roda diariamente à meia-noite (00:01) para adicionar slots do dia que está `NUM_DIAS_GERAR_SLOTS` dias no futuro (configurado para 30 dias). Mantém janela constante de slots disponíveis. Respeita slots marcados como "FOLGA" (inseridos manualmente).
- [18/12/2025] Adicionada inicialização automática de slots no startup do webhook (`whatsapp_webhook.py:36-42`): ao iniciar o bot, gera slots para os próximos 30 dias automaticamente. Antes, slots só eram gerados no modo simulação.
- [18/12/2025] Scheduler diário de slots configurado (`whatsapp_webhook.py:145-184`): todo dia à meia-noite (00:01) o sistema adiciona automaticamente slots para o próximo dia na janela de 30 dias, mantendo sempre 30 dias de antecedência disponíveis.
- [18/12/2025] **Notificações ao dono melhoradas**: Criado template `OWNER_REMINDER_RESCHEDULE_TEMPLATE` em `messages.py` (linhas 112-121) que envia UMA mensagem única ao dono contendo tanto o agendamento antigo quanto o novo em casos de reagendamento. Templates de agendamento (`OWNER_REMINDER_TEMPLATE`) e cancelamento (`OWNER_REMINDER_CANCEL_TEMPLATE`) também foram melhorados com formatação markdown e emojis para melhor visualização no WhatsApp.
- [18/12/2025] Função `send_reminder_to_owner()` atualizada (`whatsapp_webhook.py:73-120`) para suportar três tipos de notificação: novo agendamento, cancelamento simples, e reagendamento (com dados antigos e novos na mesma mensagem). Aceita novos parâmetros: `isReschedule`, `old_date`, `old_time`.
- [18/12/2025] Fluxo de reagendamento atualizado (`whatsapp_flow.py:397-475`): agora guarda os dados do agendamento antigo ANTES de cancelar (linha 400) e envia notificação completa de reagendamento ao dono com informações antigas e novas (linhas 457-466).
- [19/12/2025] Corrigida saudação duplicada para usuários cadastrados (`whatsapp_flow.py:121-140`): quando usuário já cadastrado envia saudação como "Oi", agora responde apenas com "Olá, [Nome]!" ao invés de "Olá! Seja bem-vindo(a)!" seguido de "Olá, [Nome]!". A mensagem genérica WELCOME agora só é usada para usuários não cadastrados.
- [22/12/2025] **Configuração como serviço Windows**: Adicionado bloco `if __name__ == "__main__"` com `uvicorn.run()` no final de `whatsapp_webhook.py` (linhas 881-884) para permitir execução como serviço Windows. Antes, o script executava a inicialização mas terminava imediatamente, causando loop de reinicializações.
- [22/12/2025] **Guia de serviço Windows simplificado**: Reescrito `CONFIGURAR_SERVICO_WINDOWS.md` focando exclusivamente no método NSSM, removendo métodos alternativos. Documento agora inclui parâmetros corretos validados na prática (Python real vs alias Windows Store, conta de usuário vs Local System), troubleshooting dos 6 problemas principais encontrados durante configuração, e script de atualização simplificado.

- [18/12/2025] Removida opção "Sair" do menu principal para evitar encerramentos indesejados pelo usuário. Agora o menu principal apresenta apenas: Agendar, Reagendar e Cancelar Agendamento.
- [18/12/2025] Alterado fallback para entradas desconhecidas: o bot reenvia o menu principal em vez de responder "Funcionalidade em desenvolvimento", mantendo o usuário em um fluxo guiado.
- [18/12/2025] Corrigido bug crítico: menu principal não exibia botões interativos após cancelamento de operação ou quando não havia agendamentos. Agora o webhook (`whatsapp_webhook.py:625`) detecta corretamente quando a resposta contém o texto do menu, mesmo com mensagens adicionais no início (ex: "Operação cancelada.\nSou a secretária virtual..."), e envia os botões do menu adequadamente.

- [18/12/2025] Corrigido bug de processamento de respostas interativas: normalização de `mensagem` em `processar_mensagem` (`whatsapp_flow.py`) para aceitar ids numéricos vindos do webhook (ex.: `1`, `2`, `3`). Isso resolve casos em que respostas por botão não eram reconhecidas.
- [18/12/2025] Ao cancelar o próximo agendamento por telefone (`cancelar_proximo_agendamento_por_telefone` em `agenda_service.py`), agora marcamos lembretes relacionados na aba `Lembretes` como enviados para evitar reenvios após reinício do serviço.
- [18/12/2025] Adicionada proteção para caso a linha de cabeçalho da aba `Agenda` seja deletada: `obter_worksheet_agenda()` agora verifica os cabeçalhos esperados e, se ausentes ou incorretos, insere a linha de cabeçalho no topo (fallback: sobrescrever `A1:H1`).

Próximos passos:

- Sistema de logging mais limpo, configurável e com data e hora
- Comprar chip e criar conta no whatsapp business